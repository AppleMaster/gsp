apiVersion: apps/v1
kind: Deployment
metadata:
  name: spike-dcs-mtls
  namespace: spike-dcs-mtls
  labels:
    app: nginx
spec:
  replicas: 1
  selector:
    matchLabels:
      app: nginx
  template:
    metadata:
      labels:
        app: nginx
    spec:
      containers:
      - name: nginx
        image: nginx:1.17.2
        ports:
        - containerPort: 80
        volumeMounts:
        - name: config-volume
          mountPath: /etc/nginx/nginx.conf
          subPath: nginx.conf
      volumes:
      - name: config-volume
        configMap:
          name: spike-dcs-mtls
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: spike-dcs-mtls
  namespace: spike-dcs-mtls
data:
  nginx.conf: |
        user  nginx;
        worker_processes  1;

        error_log  /var/log/nginx/error.log warn;
        pid        /var/run/nginx.pid;


        events {
          worker_connections  1024;
        }


        http {
          include       /etc/nginx/mime.types;
          default_type  application/octet-stream;

          log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
          '$status $body_bytes_sent "$http_referer" '
          '"$http_user_agent" "$http_x_forwarded_for"';

          access_log  /var/log/nginx/access.log  main;

          sendfile        on;

          keepalive_timeout  65;

          server {
            listen       80;
            server_name  localhost;

            location / {
              add_header lol $http_lol;
              add_header X-Forwarded-Client-Cert $http_x_forwarded_client_cert;
              return 200;
            }
          }
        }
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: spike-dcs-mtls
  namespace: spike-dcs-mtls
  labels:
    app: nginx
spec:
  hosts:
  - "lol.london.sandbox.govsvc.uk"
  gateways:
  - spike-dcs-mtls
  http:
  - route:
    - destination:
        host: spike-dcs-mtls.spike-dcs-mtls.svc.cluster.local
        port:
          number: 80
---
apiVersion: v1
kind: Service
metadata:
  name: spike-dcs-mtls
  namespace: spike-dcs-mtls
  labels:
    app: nginx
spec:
  type: ClusterIP
  ports:
  - name: http
    port: 80
    targetPort: 80
  selector:
    app: nginx
---
apiVersion: networking.istio.io/v1alpha3
kind: Gateway
metadata:
  name: spike-dcs-mtls
  namespace: spike-dcs-mtls
spec:
  selector:
    istio: ingressgateway
  servers:
  - port:
      number: 443
      name: https
      protocol: HTTPS
    tls:
      mode: SIMPLE
      serverCertificate: /etc/istio/ingressgateway-certs/tls.crt
      privateKey: /etc/istio/ingressgateway-certs/tls.key
    hosts:
    - "lol.london.sandbox.govsvc.uk"
---
apiVersion: v1
kind: Secret
metadata:
  name: istio-ingressgateway-certs
  namespace: istio-system
type: kubernetes.io/tls
data:
  tls.crt: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUZiakNDQTFhZ0F3SUJBZ0lERUFJU01BMEdDU3FHU0liM0RRRUJDd1VBTUZNeEN6QUpCZ05WQkFZVEFsVlQKTVE4d0RRWURWUVFJREFaRVpXNXBZV3d4RERBS0JnTlZCQW9NQTBScGN6RWxNQ01HQTFVRUF3d2NiRzlzTG14dgpibVJ2Ymk1ellXNWtZbTk0TG1kdmRuTjJZeTUxYXpBZUZ3MHhPVEEzTWpZd09USTBNREJhRncweU1EQTRNRFF3Ck9USTBNREJhTUdreEN6QUpCZ05WQkFZVEFsVlRNUTh3RFFZRFZRUUlEQVpFWlc1cFlXd3hGREFTQmdOVkJBY00KQzFOd2NtbHVaMlpwWld4a01Rd3dDZ1lEVlFRS0RBTkVhWE14SlRBakJnTlZCQU1NSEd4dmJDNXNiMjVrYjI0dQpjMkZ1WkdKdmVDNW5iM1p6ZG1NdWRXc3dnZ0VpTUEwR0NTcUdTSWIzRFFFQkFRVUFBNElCRHdBd2dnRUtBb0lCCkFRRGtWVjVmT2luR054NFk4dGhFc2VCNnU1UmJEd2RKUnVFMWpaUEtkWnBDbmJ5cmNHTnVQRjdmcS9BK0U4L3AKSmxoa0NPZmNUNWVrN0pINDZxaTc4bmpCL1p1YUI4aFpsV29aN1U3c0FMODZ3YU9mWEM1aW55bjVIUmlJZnBzZgpRZms3MVBTdnVPKzkwbmVweTlWU3k0aGU0RWRoWTNZejdKTGhISzhlWjUzRzBQOWc2SUdiRE1FTFk0SEdJR3BSCnNvdkNMZm5UYXQ3OWFxRHkwRE4vV2Fob1RWbW0rMXgxWU1NZXFFWmIxSENXa3pPbk0vM1BrdnNIOE0xdENpTEkKaUhFRll2a013UEN6cFJWbmk5OHdEbXE3dWpERDJNdUdWenJqdkxabHF5Z2MyNXI3bVJTYUVXNU4xcU9tVGlpKwpQemVHRjRvSEd0SkcxUEk3TXN3bmxCWjVBZ01CQUFHamdnRXpNSUlCTHpBSkJnTlZIUk1FQWpBQU1CRUdDV0NHClNBR0crRUlCQVFRRUF3SUdRREF6QmdsZ2hrZ0JodmhDQVEwRUpoWWtUM0JsYmxOVFRDQkhaVzVsY21GMFpXUWcKVTJWeWRtVnlJRU5sY25ScFptbGpZWFJsTUIwR0ExVWREZ1FXQkJTdGJjMGI5UThCeGx6aElnSVh1RUlmUU8xNwo4ekNCbFFZRFZSMGpCSUdOTUlHS2dCVDdUNHB6YTd5N0tpK05jT0JoeStqMnFJSWpLS0Z0cEdzd2FURUxNQWtHCkExVUVCaE1DVlZNeER6QU5CZ05WQkFnTUJrUmxibWxoYkRFVU1CSUdBMVVFQnd3TFUzQnlhVzVuWm1sbGJHUXgKRERBS0JnTlZCQW9NQTBScGN6RWxNQ01HQTFVRUF3d2NiRzlzTG14dmJtUnZiaTV6WVc1a1ltOTRMbWR2ZG5OMgpZeTUxYTRJREVBSVNNQTRHQTFVZER3RUIvd1FFQXdJRm9EQVRCZ05WSFNVRUREQUtCZ2dyQmdFRkJRY0RBVEFOCkJna3Foa2lHOXcwQkFRc0ZBQU9DQWdFQWxMWFpuU2VqN2R1RG0rdkt1TjlMWVFtSjArNXYrMi9kMndJZ1lBQnQKR0hBQURkbDN2U25VODc4QnJEZ05jMjhENFBTSUVuVkV4MXNSUTh3VTdNdnVuTXpGd1ZtNnkzU3ZXVW9oclJIdgpYRTR0VFV3NkZTaS9mYThRanZiWktqSEJWQmJEMlpoK3gyc3Bja09WbXB0OHdUSlJNbkY0OG9PWFNNUXAzVVBMCng0eDRFV0tHUlM3Tzk4MFNBbjFrVzdDK29vUzFLKzJIZkp2Tjh0TDZwY0F4ZDlha1FpcWhzOUJwR1ZrUStPdXUKNzlOQ2t2WjdOYzcyVFdxR1ZRNW5rTDZTbFpEWTVUVTBiRjRSVWp1RVpvUjdkWmR3Ni9lY2s0TitNTEczUnBZdApHYXBYVElZb3k5UWdHN2Z6UGRLUTBNU20ycWdVS2xzdG9OZHcvUk1PL3hCYnVSN2lSck1lMVhUYW02elR5TlJ3CkM2bDNOUkhPYjVVZFJjM3dycmQwUzJGZmR0YWdKMlBCcW9hdE5IQlRoUWpzNE9CTDBlM0hUa1k4VE1DeEc3TzMKb3E4Q05GaytlMy8xUWxFQnhVa1dUbEtGRUNtT1hTWEZYYUh1bC9aaXU5d3pCeDU3VEJOUDJYNXM0OXovdTlOSwpDUVF3VWFHN0thakVVeTBjU2VraFNNakRlRDJMM2hYQlpRNVpXM21CYlRhdk15MjRyQklRTkJzeXFpUmdSclFpCndORllyUy9Jb2xaOEJvSUJySGFNdFM1a1M5TFF3NE14L0NSWGZMbnoyVEZ6NStFcjBLdGhPcFFnWVBMdnZrZmsKV3ZOaFExN0lqSUhvRHZsV2RDeWlMVlBScEFhZnFKTDV4Z2lTcENhczVMRnJXekVBUkZEeXpIbnJtei8zWDB3Vwo0S0U9Ci0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0K
  tls.key: LS0tLS1CRUdJTiBSU0EgUFJJVkFURSBLRVktLS0tLQpNSUlFcEFJQkFBS0NBUUVBNUZWZVh6b3B4amNlR1BMWVJMSGdlcnVVV3c4SFNVYmhOWTJUeW5XYVFwMjhxM0JqCmJqeGUzNnZ3UGhQUDZTWllaQWpuM0UrWHBPeVIrT3FvdS9KNHdmMmJtZ2ZJV1pWcUdlMU83QUMvT3NHam4xd3UKWXA4cCtSMFlpSDZiSDBINU85VDByN2p2dmRKM3FjdlZVc3VJWHVCSFlXTjJNK3lTNFJ5dkhtZWR4dEQvWU9pQgptd3pCQzJPQnhpQnFVYktMd2kzNTAycmUvV3FnOHRBemYxbW9hRTFacHZ0Y2RXRERIcWhHVzlSd2xwTXpwelA5Cno1TDdCL0ROYlFvaXlJaHhCV0w1RE1Ed3M2VVZaNHZmTUE1cXU3b3d3OWpMaGxjNjQ3eTJaYXNvSE51YSs1a1UKbWhGdVRkYWpwazRvdmo4M2hoZUtCeHJTUnRUeU96TE1KNVFXZVFJREFRQUJBb0lCQUdseXEyU2EvZFBXZklYVgpFTitZcml6QUdDRjliVVgvLzkyMWhuMUhsbmdSVktKd0F0dFQ4aFNsMlFzeUp5QnJYd0xEd2lCU2Vadm16UHNCCmsrOUlhVkJkaU5DM3EyVUR4YjQzZyswbDR5cUZac1VmMHlRa2tVUEVsaUhqSmt4bk1XemFTaTRrNEVMdndlZWUKaE9QNXJ2N3g0TVV2STlXUytib1FmeWN4ZndIamY0NU1pc2d3bDVkUGZTZU9mcUEwTWNTbnBCUHRIaWpvMTFkMgpKelVOMlJEZ0dabEszQTNacmxlNUJweStLRzhXd2JncnJiMFhDdlJJcWRyUlp3M0MxTkNlRG5aY0ZLanFLN1FUCktud0k4aWdYczhKMllyRktCTUhnN05HZWtKazNBV01GUldQUzN2NzdDV1FsWUtsZnp2eGlsbjZQYzJ2YUwyeGQKVDJVMm55a0NnWUVBL3RVcms1QzQyeXlWYm90aGVPTWRrK1luem5iZXY2elc0MVFpL1VscFVMekErMUV6aENSVwpnSVJLUElaQUhMNG5iNnRlUVplUFowNW5kTG9lUjdYRFBOaU05NlBETFhIelJWa2VtcXZEeVpkVlI5RTRRR2dkCkhkcmxaZnU4M1gxazVEc0g4NGpmcjJQaloxRWdpREFEZncwdTUxK0l2SldtT01MbHMvQzBFcE1DZ1lFQTVXRWYKdzhzUWpmU0lwU2tuenRrdkQvbTN4WFdLUXNGRWUrVmdLdVp3UDVkeEFwNDJ4ZXdSRTNIQmVNYWFCTHVFYUFSUQp0QXFqQ0lHWXA2ZEZvalRnRkZ3TEEyTEhPMDVLWEs2OUlHTzIvdnl4STBJVllJcWowMGRaMGdJQUFGeE8wYnZ0CkdnVkVEMENkTFd0TWVmSUZVRU9TOWo4KytTamF1UERjTFlaaUhrTUNnWUFRUzlPSWtVV3hCbTNiN3QvaDJpeEgKQy8zWnJ6SlpjWlVnWG40S1VvcUFsa0dGRU5GSmp3VlZIS0NldERzZlcyMnNMM3BNbVlPYktLRm5Eb3ZuTEJGNwpMNkg4S0NYUUh5eGViKytNRnBYanEyRFJ3ZWhsL2dKMnFVdm9OS3dFUWdPVXNNMjJYamRud095RzYrSTNzMUpWCjZxTG9PdXpFbXBGUnFlMEVqODBFTHdLQmdRREovUWdLMDFQRm5iT0N0VVlmeVhLKy82akxraURwZmVWL3NOSkoKbE5qOXRxOUduZW9meWl5VFVkWU1NOTlIRVpXY1AwaU44dHYwVHFNTjU2ZlRHZnJGRXZTRHk4VWp2V0tRVVRPcwpSUUxOY2RuTzhZOS9qemFLZzhkZHZuTWYzaWx1V2EyRi8yTWFoMHloeFYzMytKNmpPbzQ4bUI4dEs4UEhuaHBWCllJUWdud0tCZ1FES3B1Mk1QcXVHSS82QnRsTGNvUy8wcjVLdlFxL1V4djl0NFZKSFNreHQrdzYwT2pWZkpDeWsKaXN0bTRhVVVjbWNDZUNsMkIwTzl5TkRudCtRNjRSblNJZnhNK2RtK2FtK0RNaHdKd3R6WXV4UytlWW9OMmlZRQp3V0UyZ3hiaHRYQzYyaXg3YUsrSEJqdXMzNFNCT3h3UTl3Q3JzNTU5RENJUkxZYUwzY1VxZkE9PQotLS0tLUVORCBSU0EgUFJJVkFURSBLRVktLS0tLQo=
